{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Twoi Znajomi</h2>

    <div class="card mb-4">
        <div class="card-header">
            Lista znajomych
        </div>
        <div class="card-body">
            {% if friendships %}
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Użytkownik</th>
                            <th>Data zawarcia znajomości</th>
                            <th style="text-align: right;">Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in friendships %}
                        {% if item.creator == user %}
                            {% with friend=item.target %}
                            <tr id="friend-row-{{ item.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if friend.avatar %}
                                            <img src="{{ friend.avatar.url }}"
                                                 alt="{{ friend.username }}"
                                                 class="rounded-circle me-2"
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                            <img src="https://ui-avatars.com/api/?name={{ friend.username }}&background=random&color=fff"
                                                 alt="{{ friend.username }}"
                                                 class="rounded-circle me-2"
                                                 style="width: 40px; height: 40px;">
                                        {% endif %}

                                        <strong>{{ friend.username }}</strong>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">{{ item.created_at|date:"d.m.Y" }}</small>
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn btn-danger btn-sm" onclick="potwierdzUsuniecie('{{ item.id }}')">
                                        Usuń
                                    </button>
                                </td>
                            </tr>
                            {% endwith %}

                        {% else %}
                            {% with friend=item.creator %}
                            <tr id="friend-row-{{ item.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if friend.avatar %}
                                            <img src="{{ friend.avatar.url }}"
                                                 alt="{{ friend.username }}"
                                                 class="rounded-circle me-2"
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                            <img src="https://ui-avatars.com/api/?name={{ friend.username }}&background=random&color=fff"
                                                 alt="{{ friend.username }}"
                                                 class="rounded-circle me-2"
                                                 style="width: 40px; height: 40px;">
                                        {% endif %}

                                        <strong>{{ friend.username }}</strong>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">{{ item.created_at|date:"d.m.Y" }}</small>
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn btn-danger btn-sm" onclick="potwierdzUsuniecie('{{ item.id }}')">
                                        Usuń
                                    </button>
                                </td>
                            </tr>
                            {% endwith %}
                        {% endif %}

                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="text-center p-4">
                    <p class="text-muted">Nie masz jeszcze żadnych znajomych.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% if pending_requests %}
    <div class="card">
        <div class="card-header bg-warning text-dark">
            Oczekujące zaproszenia
        </div>
        <div class="card-body">
            <ul class="list-group">
                {% for req in pending_requests %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        {% if req.creator.avatar %}
                            <img src="{{ req.creator.avatar.url }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ req.creator.username }}&background=random" class="rounded-circle me-2" style="width: 30px; height: 30px;">
                        {% endif %}

                        <span>Zaproszenie od: <strong>{{ req.creator.username }}</strong></span>
                    </div>
                    <span>
                        <span class="badge bg-secondary">Oczekuje</span>
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Funkcja do pobierania CSRF tokena
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Wyświetlanie modala SweetAlert2
    function potwierdzUsuniecie(friendshipId) {
        Swal.fire({
            title: 'Czy na pewno?',
            text: "Tej operacji nie można cofnąć. Znajomość zostanie usunięta.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Tak, usuń!',
            cancelButtonText: 'Anuluj'
        }).then((result) => {
            if (result.isConfirmed) {
                usunRelacjeAPI(friendshipId);
            }
        });
    }

    // Strzał do API
    function usunRelacjeAPI(id) {
        const csrftoken = getCookie('csrftoken');
        const url = `/api/friendship/${id}/`;

        fetch(url, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => {
            if (response.ok) {
                Swal.fire(
                    'Usunięto!',
                    'Użytkownik został usunięty z Twoich znajomych.',
                    'success'
                );

                // Usuwamy wiersz z tabeli z animacją
                const wiersz = document.getElementById(`friend-row-${id}`);
                if (wiersz) {
                    wiersz.style.transition = "all 0.5s";
                    wiersz.style.opacity = "0";
                    setTimeout(() => wiersz.remove(), 500);
                }
            } else {
                Swal.fire('Błąd!', 'Wystąpił problem podczas usuwania.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Błąd!', 'Nie udało się połączyć z serwerem.', 'error');
        });
    }
</script>
{% endblock %}