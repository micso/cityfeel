{% extends "base.html" %}
{% load static %}

{% block title %}Mapa Emocji - CityFeel{% endblock %}

{% block main_attrs %}{% endblock %}

{% block content %}

<div style="position: relative; height: calc(100vh - 56px); width: 100%; overflow: hidden;">

    <div id="map"
         style="height: 100%; width: 100%; z-index: 1;"
         data-api-url="{% url 'api:locations-list' %}"
         data-emotion-points-url="{% url 'api:emotion_points-list' %}"
         data-user-authenticated="{{ user.is_authenticated|lower }}"
         data-proximity-radius="{{ settings.CITYFEEL_LOCATION_PROXIMITY_RADIUS }}">
    </div>

<div id="map-filters"
         class="d-flex justify-content-center align-items-start gap-2 pt-3"
         style="position: absolute; top: 0; left: 0; width: 100%; z-index: 1000; pointer-events: none;">

        <div style="pointer-events: auto; background: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <span class="fw-bold text-secondary small text-uppercase me-2 d-none d-sm-inline" style="vertical-align: middle;">Filtruj:</span>

            <button class="btn btn-sm btn-outline-emo-1 filter-btn rounded-pill fw-bold" data-value="1">
                ğŸ˜¡
            </button>

            <button class="btn btn-sm btn-outline-emo-2 filter-btn rounded-pill fw-bold" data-value="2">
                ğŸ˜•
            </button>

            <button class="btn btn-sm btn-outline-emo-3 filter-btn rounded-pill fw-bold" data-value="3">
                ğŸ˜
            </button>

            <button class="btn btn-sm btn-outline-emo-4 filter-btn rounded-pill fw-bold" data-value="4">
                ğŸ™‚
            </button>

            <button class="btn btn-sm btn-outline-emo-5 filter-btn rounded-pill fw-bold" data-value="5">
                ğŸ˜
            </button>
        </div>
    </div>

</div>
<!-- Full-screen map container -->
<div id="map"
     style="height: calc(100vh - 56px); width: 100%;"
     data-api-url="{% url 'api:locations-list' %}"
     data-emotion-points-url="{% url 'api:emotion_points-list' %}"
     data-user-authenticated="{{ user.is_authenticated|lower }}"
     data-proximity-radius="{{ settings.CITYFEEL_LOCATION_PROXIMITY_RADIUS }}">
</div>

<!-- Modal dodawania emocji -->
<div class="modal fade" id="addEmotionModal" tabindex="-1" aria-labelledby="addEmotionModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header border-0">
        <h5 class="modal-title" id="addEmotionModalLabel">OceÅ„ to miejsce</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Proximity info (ukryte domyÅ›lnie) -->
        <div id="proximityInfo" class="alert d-none mb-3" role="alert">
          <span id="proximityText"></span>
        </div>

        <!-- Error messages -->
        <div id="emotionErrors" class="alert alert-danger d-none mb-3" role="alert"></div>

        <!-- Location name (widoczne tylko dla nowych lokalizacji) -->
        <div class="mb-3 d-none" id="locationNameContainer">
          <label for="locationName" class="form-label fw-semibold">Nazwa lokalizacji</label>
          <input type="text" class="form-control" id="locationName" name="location_name" maxlength="200" placeholder="np. Park Oliwski, GdaÅ„sk GÅ‚Ã³wny...">
          <small class="form-text text-muted">
            Opcjonalne - jeÅ›li nie podasz, zostanie wygenerowana automatycznie na podstawie wspÃ³Å‚rzÄ™dnych.
          </small>
        </div>

        <!-- Emotional value selector - gwiazdki (required) -->
        <div class="mb-4">
          <label class="form-label fw-semibold">Twoja ocena <span class="text-danger">*</span></label>
          <div class="star-rating" id="starRating">
            <input type="radio" name="emotional_value" id="star5" value="5" required>
            <label for="star5" title="Bardzo pozytywnie (5)">â˜…</label>

            <input type="radio" name="emotional_value" id="star4" value="4">
            <label for="star4" title="Pozytywnie (4)">â˜…</label>

            <input type="radio" name="emotional_value" id="star3" value="3">
            <label for="star3" title="Neutralnie (3)">â˜…</label>

            <input type="radio" name="emotional_value" id="star2" value="2">
            <label for="star2" title="Negatywnie (2)">â˜…</label>

            <input type="radio" name="emotional_value" id="star1" value="1">
            <label for="star1" title="Bardzo negatywnie (1)">â˜…</label>
          </div>
          <small class="form-text text-muted">Kliknij gwiazdkÄ™ aby oceniÄ‡ miejsce</small>
        </div>

        <!-- Privacy status selector -->
        <div class="mb-3">
          <label class="form-label fw-semibold">PrywatnoÅ›Ä‡</label>
          <select class="form-select" id="privacyStatus" name="privacy_status">
            <option value="public" selected>Publiczna - z Twoim imieniem i nazwiskiem</option>
            <option value="private">Prywatna - anonimowa</option>
          </select>
          <small class="form-text text-muted">
            Wszystkie emocje sÄ… widoczne na mapie i wpÅ‚ywajÄ… na statystyki. Prywatne emocje sÄ… anonimowe - nie pokazujÄ… kto je dodaÅ‚ i nie pojawiajÄ… siÄ™ na Twoim profilu.
          </small>
        </div>

        <!-- Coordinates display (readonly) -->
        <div class="text-muted small">
          <strong>WspÃ³Å‚rzÄ™dne:</strong> <span id="coordinatesDisplay">-</span>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-primary" id="submitEmotion">
          <span id="submitText">Dodaj ocenÄ™</span>
          <span id="submitSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast dla komunikatÃ³w sukcesu -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="successMessage">
        Twoja ocena zostaÅ‚a zapisana!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Zamknij"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Initialize Leaflet map (global variable for map.js)
  window.map = L.map('map').setView([54.3755425, 18.6088834], 12);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19,
    minZoom: 3
  }).addTo(window.map);
</script>

<!-- External map logic -->
<script src="{% static 'js/map.js' %}"></script>
{% endblock %}
