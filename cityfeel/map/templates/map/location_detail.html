{% extends "base.html" %}

{% block title %}{{ location.name }} - CityFeel{% endblock %}

{% block content %}
<div class="container my-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'map:emotion_map' %}">Mapa</a></li>
      <li class="breadcrumb-item active">{{ location.name }}</li>
    </ol>
  </nav>

  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="mb-2">{{ location.name }}</h1>
      <p class="text-muted">Lat: {{ location.coordinates.y|floatformat:4 }}, Lon: {{ location.coordinates.x|floatformat:4 }}</p>
    </div>
    <div class="col-md-4 text-end">
      {% if user_emotion_point %}
        <div class="d-flex align-items-center justify-content-end gap-2">
            <span class="badge bg-success">Już oceniłeś</span>
            <button type="button" 
                    class="btn btn-outline-danger btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#deleteModal"
                    data-action-url="{% url 'emotions:delete' user_emotion_point.pk %}"
                    data-message="Czy na pewno chcesz usunąć swoją ocenę punktu?">
                Usuń
            </button>
        </div>
      {% else %}
        <button class="btn btn-primary disabled" title="Użyj mapy głównej aby dodać ocenę">Dodaj ocenę</button>
      {% endif %}
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center d-flex flex-column justify-content-center">
          <h5 class="card-title">Średnia ocena</h5>
          {% if location.avg_emotional_value %}
            <h2 class="display-3 text-primary">{{ location.avg_emotional_value|floatformat:1 }}</h2>
            <p class="text-muted">na podstawie {{ location.emotion_points_count }} ocen</p>
          {% else %}
            <p class="text-muted mt-3">Brak ocen</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Rozkład ocen</h5>
          {% for dist in emotion_distribution %}
            <div class="d-flex align-items-center mb-2">
              <span class="me-2" style="width: 30px;">{{ dist.emotional_value }} ★</span>
              <div class="progress flex-grow-1" style="height: 20px;">
                <div class="progress-bar"
                     style="width: {% widthratio dist.count location.emotion_points_count 100 %}%;">
                  {{ dist.count }}
                </div>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">Brak danych</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body p-0">
      <div id="detail-map" style="height: 300px;"></div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Zdjęcia</h3>
    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#photoModal">
      <i class="bi bi-camera"></i> Dodaj zdjęcie
    </button>
  </div>

  <div class="row mb-4">
    {% for photo in photos %}
      <div class="col-6 col-md-3 mb-3">
        <div class="card shadow-sm h-100">
          <a href="{{ photo.image.url }}" target="_blank">
            <img src="{{ photo.image.url }}" class="card-img-top" alt="{{ photo.caption|default:location.name }}" style="height: 150px; object-fit: cover;">
          </a>
          {% if photo.caption %}
            <div class="card-footer p-2 text-muted small text-truncate">
              {{ photo.caption }}
            </div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <p class="text-muted">Brak zdjęć dla tej lokalizacji.</p>
      </div>
    {% endfor %}
  </div>

  <hr class="mb-4">

  <h3 class="mb-3">Opinie użytkowników</h3>
  {% for point in public_points %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center">
            {% if point.user.avatar %}
                <img src="{{ point.user.avatar.url }}" class="rounded-circle border me-2" style="width: 40px; height: 40px; object-fit: cover;">
            {% else %}
                <div class="rounded-circle bg-light text-primary d-flex align-items-center justify-content-center fw-bold border me-2" style="width: 40px; height: 40px;">
                    {{ point.user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            
            <div>
                <h6 class="mb-0 fw-bold">{{ point.user.username }}</h6>
                <small class="text-muted">{{ point.created_at|date:"d.m.Y H:i" }}</small>
            </div>
          </div>
          <div class="text-end">
             <span class="badge bg-primary fs-6">{{ point.emotional_value }}/5</span>
             {% if user.is_staff or user == point.user %}
                <button type="button" 
                        class="btn btn-link btn-sm text-danger p-0 border-0 text-decoration-none ms-2"
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteModal"
                        data-action-url="{% url 'emotions:delete' point.pk %}"
                        data-message="Czy na pewno chcesz usunąć tę opinię?">
                    <small>{% if user.is_staff and user != point.user %}Usuń (Admin){% else %}Usuń{% endif %}</small>
                </button>
            {% endif %}
          </div>
        </div>

        <div class="comments-section mt-3 ps-3 border-start">
            <h6 class="small text-muted mb-2">Komentarze:</h6>
            
            <div id="comments-list-{{ point.id }}" class="mb-2">
                {% for comment in point.comments.all %}
                    <div class="mb-2 bg-light p-2 rounded position-relative">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="small text-dark">{{ comment.user.username }}</strong>
                                <small class="text-muted ms-1" style="font-size: 0.75rem;">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                            </div>
                            
                            {% if user.is_staff or user == comment.user %}
                                <button type="button" 
                                        class="btn btn-link btn-sm text-danger p-0 ms-2" 
                                        style="font-size: 1.2rem; line-height: 0.5;" 
                                        title="Usuń komentarz"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal"
                                        data-action-url="{% url 'emotions:delete_comment' comment.id %}"
                                        data-message="Czy usunąć komentarz użytkownika {{ comment.user.username }}?">
                                    &times;
                                </button>
                            {% endif %}
                        </div>
                        <p class="mb-0 small text-break text-secondary pe-3">{{ comment.content }}</p>
                    </div>
                {% empty %}
                    <p class="small text-muted fst-italic mb-2" id="no-comments-{{ point.id }}">Brak komentarzy. Bądź pierwszy!</p>
                {% endfor %}
            </div>

            {% if user.is_authenticated %}
                <form class="comment-form" data-emotion-id="{{ point.id }}">
                    {% csrf_token %}
                    <div class="input-group input-group-sm">
                        <textarea name="content" class="form-control" rows="1" placeholder="Skomentuj..." required></textarea>
                        <button class="btn btn-outline-primary" type="submit">Wyślij</button>
                    </div>
                </form>
            {% else %}
                <small class="text-muted"><a href="{% url 'cf_auth:login' %}">Zaloguj się</a>, aby skomentować.</small>
            {% endif %}
        </div>

      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">Brak ocen.</div>
  {% endfor %}
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title text-danger" id="deleteModalLabel">Potwierdź usunięcie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteModalMessage">Czy na pewno chcesz to usunąć?</p>
      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Anuluj</button>
        <form id="deleteForm" method="post" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm">Usuń definitywnie</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Dodaj zdjęcie</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ photo_form.image.label_tag }}
            {{ photo_form.image }}
            {% if photo_form.image.help_text %}
              <div class="form-text">{{ photo_form.image.help_text }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ photo_form.caption.label_tag }}
            {{ photo_form.caption }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="submit" class="btn btn-primary">Wyślij</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- MAPA (Naprawa buga: używamy .y i .x + formatowanie kropki) ---
      var lat = {{ location.coordinates.y|stringformat:".6f" }};
      var lon = {{ location.coordinates.x|stringformat:".6f" }};

      if (!isNaN(lat) && !isNaN(lon)) {
          const detailMap = L.map('detail-map', {
            dragging: false, touchZoom: false, scrollWheelZoom: false, doubleClickZoom: false, zoomControl: false
          }).setView([lat, lon], 15);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
          }).addTo(detailMap);
          
          L.marker([lat, lon]).addTo(detailMap);

          // FIX z mastera: Odśwież rozmiar mapy po chwili (zapobiega szarym kafelkom)
          setTimeout(function(){ detailMap.invalidateSize()}, 200);
      }

      // --- OBSŁUGA MODALA USUWANIA ---
      const deleteModal = document.getElementById('deleteModal');
      deleteModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const actionUrl = button.getAttribute('data-action-url');
          const message = button.getAttribute('data-message');
          const modalForm = deleteModal.querySelector('#deleteForm');
          const modalMessage = deleteModal.querySelector('#deleteModalMessage');

          modalForm.action = actionUrl;
          if (message) modalMessage.textContent = message;
          else modalMessage.textContent = 'Czy na pewno chcesz to usunąć?';
      });

      // --- OBSŁUGA KOMENTARZY (AJAX) ---
      const forms = document.querySelectorAll('.comment-form');
      
      forms.forEach(form => {
          form.addEventListener('submit', function(e) {
              e.preventDefault();
              
              const emotionId = this.dataset.emotionId;
              const formData = new FormData(this);
              const submitBtn = this.querySelector('button');
              const textarea = this.querySelector('textarea');
              
              if (submitBtn.disabled) return;
              submitBtn.disabled = true;
              submitBtn.textContent = '...';

              fetch(`/emotions/comment/add/${emotionId}/`, {
                  method: 'POST',
                  headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                  body: formData
              })
              .then(response => {
                  if (!response.ok) throw new Error(`HTTP ${response.status}`);
                  return response.json();
              })
              .then(data => {
                  if (data.success) {
                      textarea.value = '';
                      const noCommentsMsg = document.getElementById(`no-comments-${emotionId}`);
                      if (noCommentsMsg) noCommentsMsg.remove();

                      const listContainer = document.getElementById(`comments-list-${emotionId}`);
                      const deleteUrl = `/emotions/comment/delete/${data.comment.id}/`;

                      const newCommentHtml = `
                        <div class="mb-2 bg-light p-2 rounded position-relative animate-new-comment">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="small text-dark">${escapeHtml(data.comment.username)}</strong>
                                    <small class="text-muted ms-1" style="font-size: 0.75rem;">Teraz</small>
                                </div>
                                
                                <button type="button" 
                                        class="btn btn-link btn-sm text-danger p-0 ms-2" 
                                        style="font-size: 1.2rem; line-height: 0.5;" 
                                        title="Usuń komentarz"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal"
                                        data-action-url="${deleteUrl}"
                                        data-message="Czy usunąć ten nowy komentarz?">
                                    &times;
                                </button>
                            </div>
                            <p class="mb-0 small text-break text-secondary pe-3">${escapeHtml(data.comment.content)}</p>
                        </div>
                      `;
                      listContainer.insertAdjacentHTML('beforeend', newCommentHtml);
                  } else {
                      alert('Błąd: ' + JSON.stringify(data.errors));
                  }
              })
              .catch(error => {
                  console.error(error);
                  alert('Błąd wysyłania: ' + error.message);
              })
              .finally(() => {
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Wyślij';
              });
          });
      });

      function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }
  });
</script>

<style>
    .animate-new-comment { animation: highlight 2s ease-out; }
    @keyframes highlight { 0% { background-color: #d1e7dd; } 100% { background-color: #f8f9fa; } }
</style>
{% endblock %}